trigger:
  - master

variables:
  UE_ROOT: 'D:\UKHO\Unreal Engine\UE_5.3' # Confirm this path matches your installation
  PROJECT_PATH: '$(Build.SourcesDirectory)\TestCICD.uproject'
  BUILD_DIR: '$(Build.ArtifactStagingDirectory)\Build'
  PACKAGE_DIR: '$(Build.ArtifactStagingDirectory)\Package'

pool:
  name: unrealengine
  workspace:
    clean: outputs

stages:
  - stage: BuildCookPackage
    displayName: Build, Cook and Package
    jobs:
      - job: build_project
        displayName: "Build Project"
        steps:
          - script: |
              echo "Building Unreal Project..."
              "%UE_ROOT%\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun ^
                -project="%PROJECT_PATH%" ^
                -noP4 ^
                -platform=Win64 ^
                -clientconfig=Development ^
                -serverconfig=Development ^
                -cook ^
                -iterativecooking ^
                -allmaps ^
                -build ^
                -stage ^
                -pak ^
                -compressed ^
                -archive ^
                -archivedirectory="%BUILD_DIR%"
            displayName: Building the project
      - job: build_shipping_package
        displayName: "Shipping Package"
        dependsOn: build_project
        steps:
          - script: |
              echo "Packaging for Production..."
              "%UE_ROOT%\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun ^
                -project="%PROJECT_PATH%" ^
                -noP4 ^
                -platform=Win64 ^
                -clientconfig=Shipping ^
                -serverconfig=Shipping ^
                -build ^
                -stage ^
                -pak ^
                -archive ^
                -archivedirectory="%PACKAGE_DIR%" ^
                -skipcook
            displayName: Building Shipping Package
  - stage: DevDeploy
    dependsOn: BuildCookPackage
    displayName: "Deploy to Dev environment"
    jobs:
      - job: DevDeploy
        steps:
          - script: |
              echo "Deploy to dev"
  - stage: QADeploy
    dependsOn: DevDeploy
    displayName: "Deploy to QA environment"
    jobs:
      - job: QADeploy
        steps:
          - script: |
              echo "Deploy to QA"
  - stage: ProdDeploy
    dependsOn: QADeploy
    displayName: "Deploy to Prod environment"
    jobs:
      - job: DevDeploy
        steps:
          - script: |
              echo "Deploy to production"
