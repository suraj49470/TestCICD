trigger:
  - master

variables:
  UE_ROOT: 'D:\UKHO\Unreal Engine\UE_5.3'
  PROJECT_PATH: '$(Build.SourcesDirectory)\TestCICD.uproject'
  BUILD_DIR: "$(Build.BinariesDirectory)"
  PACKAGE_DIR: "$(Build.ArtifactStagingDirectory)\Package"

pool: unrealengine

stages:
  - stage: BuildCookPackage
    displayName: Build, Cook, and Package
    jobs:
      - job: build_project
        displayName: "Build and Ship Package"
        steps:
          - script: |
              echo "Building Unreal Project..."
              "%UE_ROOT%\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun ^
                -project="%PROJECT_PATH%" ^
                -noP4 ^
                -platform=Win64 ^
                -clientconfig=Development ^
                -serverconfig=Development ^
                -cook ^
                -iterativecooking ^
                -allmaps ^
                -build ^
                -stage ^
                -pak ^
                -compressed ^
                -archive ^
                -archivedirectory="%BUILD_DIR%"
            displayName: Building the project

          - script: |
              echo "Packaging for Production..."
              "%UE_ROOT%\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun ^
                -project="%PROJECT_PATH%" ^
                -noP4 ^
                -platform=Win64 ^
                -clientconfig=Shipping ^
                -serverconfig=Shipping ^
                -build ^
                -stage ^
                -pak ^
                -archive ^
                -archivedirectory="%PACKAGE_DIR%" ^
                -skipcook
            displayName: Building Shipping Package

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(PACKAGE_DIR)\Windows\' # Adjust based on output
              archiveType: "zip"
              archiveFile: '$(Build.ArtifactStagingDirectory)\drop.zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)/drop.zip"
              ArtifactName: "drop"
              publishLocation: "Container"

  - stage: DevDeploy
    dependsOn: BuildCookPackage
    displayName: "Deploy to Dev environment"
    jobs:
      - job: DevDeploy
        displayName: "Deploy to dev"
        steps:
          - script: |
              echo "Deploy to dev"

  - stage: QADeploy
    dependsOn: DevDeploy
    displayName: "Deploy to QA environment"
    jobs:
      - job: QADeploy
        displayName: "Deploy to QA"
        steps:
          - script: |
              echo "Deploy to QA"

  - stage: ProdDeploy
    dependsOn: QADeploy
    displayName: "Deploy to Prod environment"
    jobs:
      - job: ProdDeploy
        displayName: "Deploy to production"
        steps:
          - script: |
              echo "Deploy to production"
